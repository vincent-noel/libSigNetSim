#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# Copyright 2014-2017 Vincent Noel (vincent.noel@butantan.gov.br)
#
# This file is part of libSigNetSim.
#
# libSigNetSim is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# libSigNetSim is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with libSigNetSim.  If not, see <http://www.gnu.org/licenses/>.

"""

	Testing the computation of equilibrium curves

"""

from libsignetsim import SbmlDocument, EquilibriumPointCurve
from unittest import TestCase
from os.path import join, dirname
from os import getcwd

class TestContinuation(TestCase):
	""" Tests high level functions """

	def testBistable(self):

		RESULT_CURVE = {
			'sos_ras_gtp': [
				(140.68442194301022, 0.0025799016263127438), (141.41152440562612, 0.002617723266176254), (142.28404554196862, 0.0026637213015764717), (143.33106829240697, 0.0027198142533707017), (144.58749184037248, 0.0027884396838520858), (146.09519471270596, 0.0028727260001720893), (147.90443043771205, 0.0029767354448942364), (150.07550224747402, 0.003105814661653679), (152.68077259953458, 0.0032671117350097376), (155.80707443769032, 0.0034703578627114495), (159.5586044853772, 0.0037290828298231983), (164.06039491951142, 0.0040625674441099801), (169.46247906004641, 0.0044991017382259085), (175.94488992195343, 0.0050816762029387962), (183.72365852108615, 0.0058784931520958674), (193.05801303984057, 0.0070037846287922239), (204.25902278455845, 0.0086629288984420069), (217.69998855737029, 0.011262798145490681), (233.82897734020256, 0.015732374343890618), (253.1841708653084, 0.024743483004529557), (276.41459655072435, 0.050550440433525738), (294.27695307840378, 0.1416205904539001), (297.82410640833888, 0.27363092189639276), (297.89832422046788, 0.30562245637820462), (297.35353935199697, 0.411104544261234), (296.65468574152794, 0.47695976481137903), (295.77729675973876, 0.54431931273668921), (294.70170032539215, 0.6173391605032732), (293.39529227350187, 0.69891176340751571), (291.81599911025501, 0.79174927415092711), (289.9122241880342, 0.89875716264967809), (287.62175748543586, 1.0232398115082377), (284.87018198759995, 1.1690595762881359), (281.5689430705786, 1.3407885060105396), (277.61318278136952, 1.5438689124644525), (272.87948553753705, 1.7847904499463452), (267.22382522034627, 2.0712861113584702), (260.48030911786043, 2.4125426162706227), (252.46193467897589, 2.8194067243663401), (242.9658306590448, 3.3045380256507464), (231.78797231595246, 3.8823896905823201), (218.75717585100219, 4.5687512993743331), (203.80597363907194, 5.3793154502671481), (187.10173964218674, 6.3264456079175098), (169.23602968036218, 7.4140378047109774), (151.3494971893561, 8.6350593318688436), (134.92481971384851, 9.9847768023445713), (121.27184660967843, 11.497820975624306), (111.31255646207072, 13.299817109141779), (106.03993339360449, 15.69602381958161), (105.64435141979565, 16.70034847682707), (109.50191919872579, 20.500481230460224), (123.64840688175958, 26.512062907797784), (158.49648311391073, 37.787298232683398), (227.70882336595596, 57.700679776114434), (306.33887511478429, 78.997592879059226), (385.13457056894953, 99.454077820372007), (463.44689483366562, 119.04574097458463)
			],
			'sos': [
				(140.68442194301022, 132.77848168623188), (141.41152440562612, 133.46501050655982), (142.28404554196862, 134.28884701410976), (143.33106829240697, 135.27745358613981), (144.58749184037248, 136.46378543999393), (146.09519471270596, 137.88738935772523), (147.90443043771205, 139.59572222143569), (150.07550224747402, 141.64573334776387), (152.68077259953458, 144.10576341677225), (155.80707443769032, 147.05782336025578), (159.5586044853772, 150.60032925776548), (164.06039491951142, 154.85138450168495), (169.46247906004641, 159.95271872342215), (175.94488992195343, 166.07441477535195), (183.72365852108615, 173.42058101330855), (193.05801303984057, 182.23615663765244), (204.25902278455845, 192.81507247536149), (217.69998855737029, 205.51002395879112), (233.82897734020256, 220.74412291486593), (253.1841708653084, 239.02451963203393), (276.41459655072435, 260.95587294885843), (294.27695307840378, 277.76463980006992), (297.82410640833888, 281.01186053193078), (297.89832422046788, 281.05647091977369), (297.35353935199697, 280.45735160416518), (296.65468574152794, 279.74424284488941), (295.77729675973876, 278.86118615709091), (294.70170032539215, 277.78627110301147), (293.39529227350187, 276.48637315971149), (291.81599911025501, 274.91956213910254), (289.9122241880342, 273.03475335350521), (287.62175748543586, 270.77051345192194), (284.87018198759995, 268.05342776694829), (281.5689430705786, 264.79615522424336), (277.61318278136952, 260.89525426944925), (272.87948553753705, 256.228912264857), (267.22382522034627, 250.65485056950902), (260.48030911786043, 244.00897169781115), (252.46193467897589, 236.10591232071548), (242.9658306590448, 226.74387676570703), (231.78797231595246, 215.71855937351876), (218.75717585100219, 202.85563001975666), (203.80597363907194, 188.07883721708899), (187.10173964218674, 171.53645296277693), (169.23602968036218, 153.78420224813632), (151.3494971893561, 135.90513504214707), (134.92481971384851, 119.30328348488851), (121.27184660967843, 105.18750915325795), (111.31255646207072, 94.326880135057792), (106.03993339360449, 87.412749077790295), (105.64435141979565, 86.228444721479093), (109.50191919872579, 86.805503755003599), (123.64840688175958, 95.321916569878823), (158.49648311391073, 119.17455910959993), (227.70882336595596, 168.63381561232518), (306.33887511478429, 226.02178145170015), (385.13457056894953, 284.37759436917133), (463.44689483366562, 343.0991359748046)
			],
			'ras_gtp': [
				(140.68442194301022, 0.045717925756520686), (141.41152440562612, 0.046149540154484546), (142.28404554196862, 0.046672375796499119), (143.33106829240697, 0.047306944205839307), (144.58749184037248, 0.048078942915776218), (146.09519471270596, 0.049020837409478928), (147.90443043771205, 0.050174054679417879), (150.07550224747402, 0.051592088453163258), (152.68077259953458, 0.053344998473114226), (155.80707443769032, 0.055526103444756107), (159.5586044853772, 0.058262240089412241), (164.06039491951142, 0.061730040400970604), (169.46247906004641, 0.066182818407149679), (175.94488992195343, 0.071997153803368338), (183.72365852108615, 0.079758403024294322), (193.05801303984057, 0.090429328341158133), (204.25902278455845, 0.1057145681211506), (217.69998855737029, 0.12895089498950923), (233.82897734020256, 0.16769348560036687), (253.1841708653084, 0.24357317023493844), (276.41459655072435, 0.45579435113183475), (294.27695307840378, 1.1996664476619789), (297.82410640833888, 2.2911398190343362), (297.89832422046788, 2.5586020478839315), (297.35353935199697, 3.449026400961233), (296.65468574152794, 4.0117296382277408), (295.77729675973876, 4.592791638506629), (294.70170032539215, 5.2290659463774691), (293.39529227350187, 5.9478456317674446), (291.81599911025501, 6.776307419141804), (289.9122241880342, 7.7452511435726077), (287.62175748543586, 8.8917476840742999), (284.87018198759995, 10.26186621716011), (281.5689430705786, 11.914056992477981), (277.61318278136952, 13.923721017396275), (272.87948553753705, 16.389668534787777), (267.22382522034627, 19.443527099490492), (260.48030911786043, 23.263779287768504), (252.46193467897589, 28.0971285715558), (242.9658306590448, 34.291482092813979), (231.78797231595246, 42.34700339463442), (218.75717585100219, 52.993368023871952), (203.80597363907194, 67.297379181201947), (187.10173964218674, 86.778956393605682), (169.23602968036218, 113.4368457851494), (151.3494971893561, 149.49977171149445), (134.92481971384851, 196.92326807652935), (121.27184660967843, 257.19495243314958), (111.31255646207072, 331.75789627327043), (106.03993339360449, 422.49924801118408), (105.64435141979565, 455.70736802059133), (109.50191919872579, 555.68396401169286), (123.64840688175958, 654.427929417526), (158.49648311391073, 746.05931520574791), (227.70882336595596, 805.09537700124497), (306.33887511478429, 822.38396641838335), (385.13457056894953, 822.88337585301679), (463.44689483366562, 816.40434630275968)
			]
		}

		RESULT_POINTS = {
			'sos_ras_gtp': [
				('LP', 297.89832422046788, 0.30562245637820462), ('LP', 105.64435141979565, 16.70034847682707)
			],
			'sos': [
				('LP', 297.89832422046788, 281.05647091977369), ('LP', 105.64435141979565, 86.228444721479093)
			],
			'ras_gtp': [
				('LP', 297.89832422046788, 2.5586020478839315), ('LP', 105.64435141979565, 455.70736802059133)
			]
		}


		testfiles_path = join(join(getcwd(), dirname(__file__)), "files")

		doc = SbmlDocument()
		doc.readSbmlFromFile(join(testfiles_path, "ras_das.xml"))

		t_ep_curve = EquilibriumPointCurve(doc.model)
		t_ep_curve.setParameter(doc.model.listOfVariables.getBySbmlId("total_sos"))
		t_ep_curve.setVariable(doc.model.listOfVariables.getBySbmlId("ras_gtp"))
		t_ep_curve.setRange(50, 450)
		t_ep_curve.setDs(1)
		t_ep_curve.setMaxSteps(1000)
		t_ep_curve.build()
		t_ep_curve.run()


		curves = t_ep_curve.getCurves()
		curve_points = t_ep_curve.getPoints()
		self.assertEqual(len(curves), 1)
		self.assertEqual(len(curve_points), 1)

		for var, xys in curves[0].items():
			for i, (x, y) in enumerate(xys):
				self.assertAlmostEqual(x, RESULT_CURVE[var][i][0], delta=1e-6*x)
				self.assertAlmostEqual(y, RESULT_CURVE[var][i][1], delta=1e-6*y)


		for var, points in curve_points[0].items():
			for i, (point_type, x, y) in enumerate(points):
				self.assertEqual(point_type, RESULT_POINTS[var][i][0])
				self.assertAlmostEqual(x, RESULT_POINTS[var][i][1])
				self.assertAlmostEqual(y, RESULT_POINTS[var][i][2])