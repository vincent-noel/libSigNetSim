#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# Copyright 2014-2017 Vincent Noel (vincent.noel@butantan.gov.br)
#
# This file is part of libSigNetSim.
#
# libSigNetSim is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# libSigNetSim is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with libSigNetSim.  If not, see <http://www.gnu.org/licenses/>.

"""

	Testing the computation of equilibrium curves

"""

from libsignetsim import SbmlDocument, EquilibriumPointCurve
from unittest import TestCase
from os.path import join, dirname
from os import getcwd

class TestContinuation(TestCase):
	""" Tests high level functions """

	def testBistable(self):

		RESULT_X = [0.30515003028491733, 0.37788932140294135, 0.465176450078502, 0.56992097473093661, 0.69561436146355093, 0.84644636384093586, 1.0274446778479287, 1.2446425267263193, 1.5052797611751179, 1.8180441772822002, 2.1933610947191249, 2.6437408457918878, 3.1841957554183082, 3.8327405071956591, 4.6109925684305528, 5.5448926796744491, 6.6655694126833485, 8.0103765975801871, 9.6241381745259336, 11.560641928201694, 13.884431843523043, 16.672958752204107, 20.019160850214966, 24.034559948811772, 28.852976447192347, 34.634986546302621, 41.573269835622639, 48.846241506275, 56.119059792440886, 63.39172530931436, 70.664238724585388, 77.936600766673294, 85.208812234552369, 92.480874009540344, 99.752787069523592, 107.02455250622771, 114.29617154632244, 121.56764557739311, 128.83897618014007, 136.11016516862207, 143.38121464099166, 150.65212704405974, 157.92290525629974, 165.19355269574609, 172.46407346196287, 179.73447252534055, 187.00475598322865, 194.27493141218474, 201.54500836127636, 208.8149990571321, 216.08491943511939, 223.35479068765767, 230.62464166047303, 237.89451269436057, 245.16446204661477, 252.43457717542799, 259.70499582529141, 266.97594858847043, 274.24785389592967, 281.52156107210681, 288.7991061323529, 296.08556998978304, 297.88981566671538, 297.89832422046783, 293.70079882555427, 290.68612681356575, 287.04733806848697, 282.67512946792112, 277.43602378067681, 271.17249623698837, 264.54261251987464, 257.96099550151484, 251.43570149222967, 244.97481377880055, 238.5868147745924, 232.2807577793173, 226.06633585883642, 219.95387997872513, 213.95429555525612, 208.07893842894146, 202.33943027282967, 196.74741600056001, 191.31427152179972, 186.05077695097026, 180.96677728798269, 176.07085770629521, 171.37006192473916, 166.8696793866421, 162.57311963996312, 158.48188210168178, 154.59561834154368, 150.91227413199798, 147.4282919356271, 144.13885142131898, 141.0381261936183, 138.11953807039808, 135.37599474167166, 132.80010156009357, 130.38434262820661, 128.12122991309428, 126.00342162427494, 124.02381272099976, 122.17560122545959, 120.45233428121765, 118.84793778034943, 117.35673305002736, 115.97344363385236, 114.69319474445645, 113.51150749411593, 112.42428960806383, 111.42782396498667, 110.51875601593892, 109.69408088832539, 108.95113079170581, 108.28756319101255, 107.70135009863209, 107.19076875347082, 106.75439389251416, 106.3910917805873, 106.10001613849315, 105.88060609600446, 105.73258629518691, 105.65596927525532, 105.64435141979564, 105.68046312196122, 105.78936999930326, 105.97216983593611, 106.23029287209341, 106.56552026700858, 106.98000632175841, 107.47630482805866, 108.05739995233135, 108.72674210248054, 109.48828924908833, 110.34655418127568, 111.30665814682541, 112.37439124074241, 113.55627972997573, 114.85966018534938, 116.29275977311244, 117.8647812233373, 119.58598972116414, 121.46779706961949, 123.52283571311511, 125.76501133090628, 128.20951745651246, 130.87278881532458, 133.77236199208926, 136.92660365066942, 140.35426003172333, 144.07378115205978, 148.10238571297322, 152.45486614018523, 157.14219374363876, 162.17006895805184, 167.5376506477902, 173.2367517321141, 179.25175829871648, 185.56039374417736, 192.13524057925608, 198.94573567773901, 205.96025737570167, 213.14795863490565, 220.48013190481464, 227.93104536983316, 235.47830804197054, 243.10288035112771, 250.78885646637207, 258.52312509247542, 266.29498582973611, 274.09577001127286, 281.91849290868089, 289.7575491989532, 297.60845435621303, 305.46762951701231, 313.33222504186614, 321.19997716467708, 329.0690922748397, 336.93815386735383, 344.80604789539694, 352.67190295215357, 360.53504233894603, 368.39494564538097, 376.25121792518308, 384.10356493721576, 391.95177323099739, 399.7956941065874, 407.63523067575881, 415.47032741366951, 423.30096170664842, 431.12713701125506, 438.94887731074209, 446.76622262053229, 454.57922534315742, 462.38794731198669, 470.19245739542151, 477.99282955598073, 485.78914128149347, 493.58147231858987
		]


		RESULT_CURVE = {'sos_ras_gtp': [6.7096131098871097e-09, 1.0291993584552417e-08, 1.5600024776995107e-08, 2.3424086906882985e-08, 3.4909432154026017e-08, 5.1714397022690365e-08, 7.6239116532908736e-08, 1.1195628758027527e-07, 1.6388977250782361e-07, 2.393076088525692e-07, 3.4872636751423278e-07, 5.0736834878523127e-07, 7.3727866688166709e-07, 1.0704061707088754e-06, 1.553096082240864e-06, 2.2526573192725679e-06, 3.2669911754468494e-06, 4.7387593143829206e-06, 6.8763221164553656e-06, 9.98484639764842e-06, 1.4512818163214491e-05, 2.1122131350332041e-05, 3.0794704635425919e-05, 4.499654126163084e-05, 6.5933758639711863e-05, 9.6959102409696721e-05, 0.00014323127085577014, 0.00020312206807107433, 0.0002756364477355297, 0.00036187396345174039, 0.00046306761591834698, 0.00058060474381420486, 0.00071605196962113479, 0.00087118515021701224, 0.00104802554541011, 0.0012488837661004532, 0.0014764135292325311, 0.0017336778745059502, 0.0020242313534539051, 0.0023522228808563134, 0.0027225255837941592, 0.0031409023093046219, 0.0036142187857699857, 0.0041507212874448765, 0.0047604028388464753, 0.0054554928355625976, 0.0062511216422816871, 0.0071662379934788216, 0.0082248994193250703, 0.0094581263132158932, 0.010906630918959246, 0.012624947001133419, 0.014687883564549189, 0.017201000085117775, 0.020318398122710472, 0.024274661079524258, 0.029446320022907143, 0.036481322070800501, 0.046607562840267215, 0.062515255268043052, 0.091800844504079174, 0.1769687927790162, 0.2944039121994308, 0.30562244973753289, 0.68032221894684886, 0.85574765792377316, 1.0539548654819326, 1.2835366689404477, 1.5529177936568956, 1.8713546724529011, 2.2069419353200779, 2.5401834529459797, 2.8716336603233175, 3.2015245730353148, 3.5299089356570077, 3.8567259842110548, 4.1818348972598036, 4.5050337530057902, 4.8260719904550138, 5.1446603770624595, 5.4604806321145061, 5.7731958775956667, 6.0824624173203077, 6.3879428346802269, 6.6893199543668524, 6.98631085783183, 7.2786799426964306, 7.5662499776968852, 7.8489102737834102, 8.1266214127379577, 8.3994163774991932, 8.6673983403344881, 8.9307356762996744, 9.1896549692902756, 9.4444328297393643, 9.6953872817807394, 9.9428693467343905, 10.1872552786716, 10.428939741412835, 10.668330069775587, 10.905841649004634, 11.141894365298148, 11.376910034258387, 11.611310690366681, 11.845517614365018, 12.079950979829691, 12.315030013505218, 12.551173576711104, 12.78880109304974, 13.028333761693734, 13.270196010588089, 13.514817155899831, 13.762633245735666, 14.01408907521906, 14.269640368614253, 14.529756131562653, 14.794921182452523, 15.06563887854999, 15.342434057638211, 15.625856221113368, 15.9164829905699, 16.214923874739753, 16.521824390316301, 16.700348391385205, 17.021917536841766, 17.353802239016389, 17.696816772088102, 18.051836299499943, 18.419804075053985, 18.801739465067431, 19.198746894096143, 19.612025826598941, 20.042881902634932, 20.492739345932709, 20.963154759591379, 21.455832407144012, 21.972641043403623, 22.515632298369834, 23.087060514812286, 23.689403780027952, 24.325385640081429, 24.997996611734173, 25.710514060487991, 26.46651823098885, 27.269901135732994, 28.12486357195786, 29.035893726665112, 30.007718728804132, 31.045218438994457, 32.153289378949111, 33.336647219905039, 34.599560503923286, 35.945518320297126, 37.376851946731506, 38.894353730946861, 40.496959559924193, 42.181572949724988, 43.943096509765397, 45.774695699632552, 47.66826113360586, 49.614983672036843, 51.605934443410113, 53.632556906380692, 55.687017670833235, 57.762406134036397, 59.852804338532579, 61.953262774925264, 64.05971855082224, 66.168885562175561, 68.278137321843317, 70.385395002474752, 72.489027145198435, 74.587763465218174, 76.680622807341578, 78.766854060666404, 80.845888342413971, 82.917300644847202, 84.980779265330739, 87.036101536058524, 89.083114605265109, 91.121720241881633, 93.151862829090703, 95.173519881627087, 97.18669455618533, 99.19140973560576, 101.18770335579718, 103.17562471488688, 105.15523155903689, 107.12658778404787, 109.08976162387295, 111.04482422665491, 112.99184853807664, 114.93090842920503, 116.86207801890285, 118.78543115106089, 120.70104099527889, 122.60897974549383, 124.50931839683496, 126.40212658427916], 'sos': [0.28787766307760959, 0.35649978309988772, 0.4388463490310911, 0.53766225968999726, 0.65624139789870573, 0.79853642914819356, 0.96929056081715492, 1.1741956544153824, 1.4200819619756562, 1.7151458121709386, 2.0692228371771355, 2.4941158499777627, 3.0039883044250479, 3.6158364578111604, 4.3500559810574044, 5.2311219126673869, 6.2884046347157803, 7.5571490889560575, 9.0796499007101712, 10.906661620279396, 13.099091145788805, 15.730028821622454, 18.887186030319192, 22.675820694703031, 27.222248440288297, 32.678056787972118, 39.225163317864045, 46.088389958978532, 52.951779111503839, 59.815330112263474, 66.679042241790768, 73.542914715444468, 80.406946672794177, 87.271137164868605, 94.135485138746461, 100.99998941881958, 107.86464868385671, 114.72946143872544, 121.59442597925849, 128.45954034823941, 135.32480227976689, 142.19020912824291, 149.05575777677251, 155.92144451763372, 162.78726489431452, 169.65321348982334, 176.51928363857587, 183.38546702744438, 190.25175313252691, 197.11812840638058, 203.98457507547892, 210.85106930896026, 217.71757833463519, 224.58405571273346, 231.45043321050733, 238.31660598488284, 245.18240347046401, 252.04752630675299, 258.91138993989728, 265.77265026953478, 272.62716977491266, 279.44582961303809, 281.0573843461475, 281.05647092507473, 276.78996885136741, 273.80055409406555, 270.20307465746504, 265.88737462214795, 260.72058954001938, 254.54647036278999, 248.0124714399297, 241.52603251638075, 235.0943215795732, 228.72478882737278, 222.42540417084891, 216.20476708211442, 210.072144992376, 204.03745640165116, 198.11120098563146, 192.30433446162982, 186.62808651453159, 181.09372327443765, 175.7122618355765, 170.49415109730299, 165.44894009282743, 160.58496008760889, 155.90904815407816, 151.42633735809608, 147.14013163190094, 143.05187350572885, 139.16120211151741, 135.4660892023258, 131.96303447178568, 128.64729838984761, 125.51315129142534, 122.55412048094419, 119.76322147001403, 117.13316424823695, 114.65652979050354, 112.32591548945724, 110.13405065513376, 108.07388482836481, 106.13865245655515, 104.32191774738941, 102.6176034113227, 101.0200066856622, 99.523805592032076, 98.124057935337291, 96.816195094138067, 95.596012261270175, 94.459656441199542, 93.403613223972826, 92.424693115222652, 91.520018015052656, 90.687008288962474, 89.923370760260354, 89.227087869950708, 88.596408185665624, 88.02983839954338, 87.526136926702691, 87.084309198179966, 86.703604737426616, 86.383516109578295, 86.228444790444186, 86.002999132753473, 85.837991967275826, 85.733805580714929, 85.691087471498236, 85.710762031526684, 85.794045126357872, 85.942461838631431, 86.157867672896955, 86.44247355185378, 86.798874957299148, 87.230085580284054, 87.739575830955403, 88.331316505660695, 89.009827792588851, 89.780233582064284, 90.648320688086002, 91.620602003371104, 92.704381711178627, 93.907819326258448, 95.23998736029678, 96.710914610215156, 98.331603256353461, 100.11400301493066, 102.07091962863933, 104.21582868935177, 106.5625607223307, 109.12482269960908, 111.91552954258995, 114.94594258886644, 118.22465527417557, 121.75652788592593, 125.54173895759661, 129.57516210238364, 133.84625890056157, 138.33958345210749, 143.03584408384413, 147.91332331263047, 152.94938250290943, 158.12179900225328, 163.40977556001917, 168.79457245866931, 174.25979894338511, 179.79144511527778, 185.37774410787443, 191.00894152939713, 196.67702842694112, 202.37547395340911, 208.09897802692129, 213.84325332924834, 219.60483917110292, 225.38094590788347, 231.1693267828571, 236.96817337417718, 242.77603085896146, 248.59172960810679, 254.41433009334546, 260.24307856261584, 266.07737137786205, 271.91672630926666, 277.76075940354275, 283.60916631836955, 289.46170723637294, 295.31819465181854, 301.17848346498937, 307.04246293654222, 312.91005013826981, 318.78118461649666, 324.65582403590832, 330.53394061951116, 336.41551823618522, 342.30055001584981, 348.18903639610272, 354.08098352096113, 359.9764019292486, 365.87530547976877], 'ras_gtp': [5.4840395728042712e-05, 6.7928387732859211e-05, 8.3641895922903758e-05, 0.00010250951710152751, 0.00012516711171475846, 0.00015237994126491655, 0.00018506953827936707, 0.00022434639237833156, 0.00027154981505694739, 0.00032829670965865313, 0.00039654145253033643, 0.00047864973054182434, 0.00057749004260818201, 0.00069654775158048822, 0.00084006820575016779, 0.0010132377435439236, 0.0012224146673765015, 0.0014754270142016436, 0.001781960937636782, 0.0021540740006160699, 0.0026068837190918945, 0.0031595067722126656, 0.0038363644238812423, 0.0046690356286853496, 0.0056989508402711673, 0.0069814146530700599, 0.0085917999174083479, 0.01036994953044971, 0.01224805584430517, 0.014234948594284239, 0.016340529562997572, 0.018575940513922872, 0.020953763742212826, 0.023488262888139592, 0.026195673779701004, 0.029094557878595894, 0.03220623465442575, 0.035555314271563068, 0.039170358870372353, 0.043084710233271088, 0.047337534895195557, 0.051975156518469984, 0.057052772255517151, 0.062636689003849916, 0.068807273488999787, 0.075662897664508538, 0.083325295730107315, 0.091946961384463802, 0.10172155681833923, 0.11289887457101724, 0.12580687032973301, 0.14088502252837912, 0.1587364984425583, 0.18021288843637606, 0.20655824627196157, 0.23966793821536586, 0.28258740389489273, 0.34056436153236685, 0.4235613341199953, 0.55346070458556018, 0.79229809430497289, 1.490081852560273, 2.4646749244450783, 2.5586019922414724, 5.783295431083582, 7.3539803732659976, 9.1778889055119244, 11.358517056899434, 14.014712941604122, 17.298167436065643, 20.937675123938408, 24.746410065840291, 28.740741323378561, 32.934772981964144, 37.34136446715911, 41.972475894426978, 46.83920147205307, 51.951634791852719, 57.318634435902283, 62.947531963000401, 68.843816397495758, 75.010828948716792, 81.449502308723311, 88.158178048473374, 95.13253064289934, 102.36561680525955, 109.84805532643512, 117.56832684853174, 125.51316876492471, 133.66803019782162, 142.01754765744155, 150.54600430212844, 159.23774254700999, 168.0775099472049, 177.05072866752678, 186.14368792829177, 195.34366570171241, 204.63898994143793, 214.01905141675766, 223.47428014250514, 232.99609636953596, 242.57684525387759, 252.20972248130983, 261.88869631703625, 271.60842998572463, 281.36420697962251, 291.1518609630765, 300.9677111105064, 310.808503270242, 320.67135692762241, 330.55371774070721, 340.45331525168666, 350.36812532538426, 360.29633681219491, 370.23632194101071, 380.18660996567371, 390.14586359209272, 400.11285776833358, 410.08646043009128, 420.06561481236656, 430.04932298284058, 440.03663023876675, 450.02661004303354, 455.7073653246411, 465.69969743844109, 475.69234695140335, 485.68436445177321, 495.67475677242953, 505.66246808975285, 515.64635880582705, 525.62518151475604, 535.59755327981043, 545.56192327788312, 555.51653462611171, 565.45937900256422, 575.38814233029188, 585.30013943037795, 595.19223509290453, 605.0607484699425, 614.90133713411092, 624.70885646405145, 634.47718944151052, 644.19904151935259, 653.86569517189741, 663.46671954409169, 672.98963293168413, 682.4195206229582, 691.7386192446919, 700.92589308458514, 709.95664918222963, 718.80226687845357, 727.43015138471321, 735.80405067379127, 743.8848841500477, 751.63219594680822, 759.00624335460486, 765.97056311828487, 772.494667006447, 778.55638758203725, 784.14340930003505, 789.25370235314529, 793.89485668457462, 798.08256888493179, 801.838668607822, 805.18906422817918, 808.16188650099832, 810.78597986883369, 813.08978192999712, 815.10056122923152, 816.84394991231068, 818.34369989713969, 819.62159751772697, 820.69748372162633, 821.58933984249495, 822.31341036318213, 822.88434316328164, 823.31533450691052, 823.61827085852883, 823.80386293023616, 823.88176957670237, 823.86071057935965, 823.74856824725691, 823.55247828493339, 823.27891066171151, 822.93374134838541, 822.5223158237103, 822.04950523267371, 821.51975602639391, 820.93713384513921, 820.30536233255577, 819.62785749467957, 818.90775814748031, 818.14795293153668, 817.35110431365058, 816.51966994269083, 815.65592168035027, 814.76196258685115, 813.83974210559552, 812.89106965991664]
		}

		RESULT_POINTS = {
			'sos_ras_gtp': [
				('LP', 297.89832422046788, 0.30562245637820462), ('LP', 105.64435141979565, 16.70034847682707)
			],
			'sos': [
				('LP', 297.89832422046788, 281.05647091977369), ('LP', 105.64435141979565, 86.228444721479093)
			],
			'ras_gtp': [
				('LP', 297.89832422046788, 2.5586020478839315), ('LP', 105.64435141979565, 455.70736802059133)
			]
		}

		testfiles_path = join(join(getcwd(), dirname(__file__)), "files")

		doc = SbmlDocument()
		doc.readSbmlFromFile(join(testfiles_path, "ras_das.xml"))

		t_ep_curve = EquilibriumPointCurve(doc.model)
		t_ep_curve.setParameter(doc.model.listOfVariables.getBySbmlId("total_sos"))
		t_ep_curve.setVariable(doc.model.listOfVariables.getBySbmlId("ras_gtp"))
		t_ep_curve.setRange(0, 500)
		t_ep_curve.setDs(0.1)
		t_ep_curve.setMaxSteps(200)
		t_ep_curve.build()
		t_ep_curve.run()

		x, ys = t_ep_curve.getCurves()
		curve_points = t_ep_curve.getPoints()

		self.assertEqual(len(x), 199)
		self.assertEqual(len(ys.keys()), 3)
		self.assertEqual(len(ys['sos']), 199)
		self.assertEqual(len(curve_points), 3)

		for i, x in enumerate(x):
			self.assertAlmostEqual(x, RESULT_X[i], delta=1e-6 * x)

		for var, y in ys.items():
			for i, y_i in enumerate(y):
				self.assertAlmostEqual(y_i, RESULT_CURVE[var][i], delta=1e-6*y_i)

		for var, points in curve_points.items():
			for i, (point_type, x, y) in enumerate(points):
				self.assertEqual(point_type, RESULT_POINTS[var][i][0])
				self.assertAlmostEqual(x, RESULT_POINTS[var][i][1], delta=1e-6*x)
				self.assertAlmostEqual(y, RESULT_POINTS[var][i][2], delta=1e-6*y)
